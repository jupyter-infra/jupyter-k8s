apiVersion: workspace.jupyter.org/v1alpha1
kind: WorkspaceAccessStrategy
metadata:
  name: access-strategy-two-ingressroutes
  namespace: jupyter-k8s-shared
spec:
  displayName: Test Access Strategy With Two IngressRoutes
  accessResourceTemplates:
    # The regular route for authenticated requests
    - kind: IngressRoute
      apiVersion: traefik.io/v1alpha1
      namePrefix: primary-route
      template: |
        spec:
          entryPoints:
            - websecure
          routes:
            - match: "Host(`example.com`) && PathPrefix(`/workspaces/{{ .Workspace.Namespace }}/{{ .Workspace.Name }}/`)"
              kind: Rule
              priority: 100
              services:
                - name: "{{ .Service.Name }}"
                  namespace: "{{ .Service.Namespace }}"
                  port: 8888

    # The auth route for initial authentication
    - kind: IngressRoute
      apiVersion: traefik.io/v1alpha1
      namePrefix: auth-route
      template: |
        spec:
          entryPoints:
            - websecure
          routes:
            - match: "Host(`example.com`) && PathPrefix(`/workspaces/{{ .Workspace.Namespace }}/{{ .Workspace.Name }}/auth`)"
              kind: Rule
              priority: 200
              services:
                - name: "{{ .Service.Name }}"
                  namespace: "{{ .Service.Namespace }}"
                  port: 8888

  accessURLTemplate: "https://example.com/workspaces/{{ .Workspace.Namespace }}/{{ .Workspace.Name }}/"
