apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: auth-headers
  namespace: {{ .Values.namespace }}
spec:
  headers:
    sslRedirect: true
    stsSeconds: 315360000
    browserXssFilter: true
    contentTypeNosniff: true
    forceSTSHeader: true
    sslHost: {{ .Values.domain }}
    stsIncludeSubdomains: true
    stsPreload: true
    frameDeny: false
---
{{- if .Values.authmiddleware.enabled }}
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: authmiddleware-bearer-auth
  namespace: {{ .Values.namespace }}
  labels:
    app: authmiddleware
    component: auth
spec:
  forwardAuth:
    address: "http://authmiddleware.{{ .Values.namespace }}:8080/bearer-auth"
    trustForwardHeader: true
    addAuthCookiesToResponse:
      - "{{ .Values.authmiddleware.cookieName }}"
      - "{{ .Values.authmiddleware.csrfCookieName }}"
    authRequestHeaders:
      - "Cookie"
      - "X-Forwarded-Uri"
      - "X-Forwarded-Host"
      - "X-Forwarded-Proto"
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: authmiddleware-verify
  namespace: {{ .Values.namespace }}
  labels:
    app: authmiddleware
    component: auth
spec:
  forwardAuth:
    address: "http://authmiddleware.{{ .Values.namespace }}:8080/verify"
    trustForwardHeader: true
    addAuthCookiesToResponse:
      - "{{ .Values.authmiddleware.cookieName }}"
      - "{{ .Values.authmiddleware.csrfCookieName }}"
    authRequestHeaders:
      - "Cookie"
      - "X-Forwarded-Uri"
      - "X-Forwarded-Host"
      - "X-Forwarded-Proto"
{{- end }}
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: workspace-auth-redirect
  namespace: {{ .Values.namespace }}
  labels:
    app: authmiddleware
    component: auth
spec:
  redirectRegex:
{{- if eq .Values.authmiddleware.routingMode "subdomain" }}
    regex: "^(https?://[^/]+)/?$"
    replacement: "${1}/bearer-auth"
{{- else }}
    regex: "^(https?://[^/]+/workspaces/[^/]+/[^/]+)/?$"
    replacement: "${1}/bearer-auth"
{{- end }}
    permanent: false
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: strip-bearer-auth-suffix
  namespace: {{ .Values.namespace }}
  labels:
    app: authmiddleware
    component: auth
spec:
  redirectRegex:
    permanent: false
{{- if eq .Values.authmiddleware.routingMode "subdomain" }}
    regex: "^(https?://[^/]+)/bearer-auth.*$"
    replacement: "${1}/"
{{- else }}
    regex: "^(https?://[^/]+/workspaces/[^/]+/[^/]+)/bearer-auth.*$"
    replacement: "${1}/"
{{- end }}
